services:
  radiant:
    build:
      context: .
      dockerfile: Dockerfile.radiant
      args:
        RADIANT_VERSION: ${RADIANT_VERSION:-main}
    container_name: radiant-node-${NETWORK:-mainnet}
    restart: unless-stopped
    ports:
      - "${RXD_RPC_PORT:-7332}:${RXD_RPC_PORT:-7332}"
      - "${RXD_P2P_PORT:-7333}:${RXD_P2P_PORT:-7333}"
      - "29332:29332" # ZMQ hashblock
      - "29333:29333" # ZMQ rawblock
    volumes:
      - radiant-data-${NETWORK:-mainnet}:/home/radiant/.radiant
    environment:
      - RXD_RPC_USER=${RXD_RPC_USER}
      - RXD_RPC_PASS=${RXD_RPC_PASS}
      - RXD_RPC_PORT=${RXD_RPC_PORT:-7332}
      - RXD_P2P_PORT=${RXD_P2P_PORT:-7333}
      - RXD_ZMQ_PORT=${RXD_ZMQ_PORT:-29332}
      - RXD_ZMQ_RAW_PORT=${RXD_ZMQ_RAW_PORT:-29333}
      - TESTNET=${TESTNET:-false}
    # Configuration is generated by entrypoint script from environment variables
    # No command needed - entrypoint handles everything
    networks:
      - radiant-net
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  stratum-proxy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: radiant-stratum-proxy-${NETWORK:-mainnet}
    restart: unless-stopped
    ports:
      - "${STRATUM_PORT:-54321}:${STRATUM_PORT:-54321}"
      - "${DASHBOARD_PORT:-8080}:${DASHBOARD_PORT:-8080}"
    depends_on:
      radiant:
        condition: service_healthy
    environment:
      - RXD_RPC_HOST=radiant
      - RXD_RPC_PORT=${RXD_RPC_PORT:-7332}
      - RXD_RPC_USER=${RXD_RPC_USER}
      - RXD_RPC_PASS=${RXD_RPC_PASS}
      - STRATUM_PORT=${STRATUM_PORT:-54321}
      - TESTNET=${TESTNET:-false}
      - NETWORK=${NETWORK:-mainnet}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - SHOW_JOBS=${SHOW_JOBS:-false}
      - USE_EASIER_TARGET=${USE_EASIER_TARGET:-true}
      - STATIC_SHARE_DIFFICULTY=${STATIC_SHARE_DIFFICULTY:-512.0}
      - PROXY_SIGNATURE=${PROXY_SIGNATURE:-/radiant-stratum-proxy/}
      - ENABLE_ZMQ=${ENABLE_ZMQ:-true}
      - RXD_ZMQ_ENDPOINT=${RXD_ZMQ_ENDPOINT:-tcp://radiant:28332}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - ENABLE_DASHBOARD=${ENABLE_DASHBOARD:-false}
      - DASHBOARD_PORT=${DASHBOARD_PORT:-8080}
      - ENABLE_DATABASE=${ENABLE_DATABASE:-false}
      - ENABLE_VARDIFF=${ENABLE_VARDIFF:-false}
      - VARDIFF_TARGET_SHARE_TIME=${VARDIFF_TARGET_SHARE_TIME:-15.0}
      - VARDIFF_MIN_DIFFICULTY=${VARDIFF_MIN_DIFFICULTY:-512.0}
      - VARDIFF_MAX_DIFFICULTY=${VARDIFF_MAX_DIFFICULTY:-5000.0}
      - VARDIFF_START_DIFFICULTY=${VARDIFF_START_DIFFICULTY:-1024.0}
      - VARDIFF_RETARGET_SHARES=${VARDIFF_RETARGET_SHARES:-10}
      - VARDIFF_RETARGET_TIME=${VARDIFF_RETARGET_TIME:-90.0}
      - VARDIFF_UP_STEP=${VARDIFF_UP_STEP:-2.0}
      - VARDIFF_DOWN_STEP=${VARDIFF_DOWN_STEP:-0.5}
      - VARDIFF_EMA_ALPHA=${VARDIFF_EMA_ALPHA:-0.3}
      - VARDIFF_INACTIVITY_LOWER=${VARDIFF_INACTIVITY_LOWER:-90.0}
      - VARDIFF_INACTIVITY_MULTIPLES=${VARDIFF_INACTIVITY_MULTIPLES:-6.0}
      - VARDIFF_INACTIVITY_DROP_FACTOR=${VARDIFF_INACTIVITY_DROP_FACTOR:-0.5}
      - VARDIFF_STATE_PATH=data/${NETWORK:-mainnet}/vardiff_state.json
      - VARDIFF_WARM_START_MINUTES=${VARDIFF_WARM_START_MINUTES:-60}
      - VARDIFF_CHAIN_HEADROOM=${VARDIFF_CHAIN_HEADROOM:-0.9}
    command: ["/app/entrypoint.sh"]
    networks:
      - radiant-net
    volumes:
      - ./submit_history/${NETWORK:-mainnet}:/app/submit_history
      - ./data/${NETWORK:-mainnet}:/app/data
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import socket; s=socket.socket(); s.connect(('localhost', ${STRATUM_PORT:-54321})); s.close()",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  radiant-net:
    driver: bridge

volumes:
  radiant-data-mainnet:
    driver: local
  radiant-data-testnet:
    driver: local