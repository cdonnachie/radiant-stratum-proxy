<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Radiant Solo Mining Dashboard</title>
    <link rel="stylesheet" href="/static/dashboard.css" />
    <link rel="icon" type="image/png" href="/static/radiant-logo.png" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>
        <img
          src="/static/radiant-logo.png"
          alt="RXD"
          class="logo"
          onerror="this.style.display='none'"
        />
        Radiant Solo Mining Dashboard
      </h1>

      <nav class="dashboard-nav">
        <a href="/" class="nav-link active">Overview</a>
        <a href="/shares" class="nav-link">Live Shares</a>
      </nav>

      <div class="stats-grid">
        <div class="stat-card" title="Current aggregated rolling hashrate (5m window). Toggle shows Instant (raw window) vs EMA (smoothed).">
          <h3 style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
            <span>Total Hashrate</span>
            <label style="font-size: 0.55em; display: flex; align-items: center; gap: 4px; cursor: pointer; opacity: 0.8;">
              <input type="checkbox" id="mode-toggle-hashrate" style="accent-color: #05a532; cursor: pointer" />
              <span title="Toggle between EMA (smoothed) and Instant (raw) aggregate hashrate">Instant</span>
            </label>
          </h3>
          <div style="display: flex; align-items: baseline; gap: 10px">
            <div class="value" id="total-hashrate">0.00</div>
            <div class="unit" id="total-hashrate-unit">H/s</div>
            <div id="total-hashrate-conf" style="font-size: 0.55em; letter-spacing: 0.5px; padding: 4px 8px; border-radius: 16px; background: rgba(255, 255, 255, 0.18); display: none;">¬±100%</div>
          </div>
          <div class="subtext" id="hashrate-subtext">Waiting for first share‚Ä¶</div>
        </div>

        <div class="stat-card">
          <h3>Active Miners</h3>
          <div class="value" id="miner-count">0</div>
          <div class="unit">Connected</div>
        </div>

        <div class="stat-card" title="Accepted vs total submitted shares over last 24h">
          <h3>Acceptance Rate</h3>
          <div class="value" id="acceptance-rate">‚Äî</div>
          <div class="unit">%</div>
        </div>

        <div class="stat-card" title="Time to find estimates: Now (current), 12h (medium-term avg), 24h (daily avg)">
          <h3>Time To Find</h3>
          <div style="display: flex; flex-direction: column; gap: 6px; margin-top: 8px;">
            <div style="display: flex; gap: 8px; align-items: center">
              <span style="font-size: 0.85em; opacity: 0.7; min-width: 35px">RXD:</span>
              <span id="ttf-rxd" class="value" style="font-size: 1em; min-width: 40px">‚Äî</span>
              <span id="ttf-rxd-12h" class="value" style="font-size: 1em; min-width: 40px">‚Äî</span>
              <span id="ttf-rxd-24h" class="value" style="font-size: 1em; min-width: 40px">‚Äî</span>
            </div>
          </div>
          <div class="subtext" style="margin-top: 6px">Now | 12h | 24h</div>
        </div>

        <div class="stat-card rxd-blocks-card" title="Blocks found in the last 24h and all-time total (accepted only)">
          <h3>
            <img src="/static/radiant-logo.png" alt="RXD" class="chain-logo" onerror="this.style.display='none'" />
            RXD Blocks
          </h3>
          <div class="value" id="rxd-blocks">0</div>
          <div class="unit">24h</div>
          <div class="subtext" id="rxd-blocks-alltime">All time: 0</div>
        </div>

        <div class="stat-card">
          <h3>Total Shares</h3>
          <div class="value" id="total-shares">0</div>
          <div class="unit">24h</div>
        </div>

        <div class="stat-card" title="Shares submitted (accepted + rejected) since the last found block">
          <h3>Shares Since Block</h3>
          <div class="value" id="shares-since-block">‚Äî</div>
          <div class="unit" id="shares-since-block-age">‚Äî</div>
        </div>

        <div class="stat-card rxd-earnings-card" id="earnings-card" style="display: none; position: relative; cursor: help; overflow: visible;">
          <h3>
            <img src="/static/radiant-logo.png" alt="RXD" class="chain-logo" onerror="this.style.display='none'" />
            Est RXD Earnings
          </h3>
          <div class="value" id="earnings-daily-usd" style="font-size: 1.8em">‚Äî</div>
          <div class="unit">Daily USD</div>
          <div class="subtext" style="margin-top: 8px">
            <span style="opacity: 0.7">Weekly:</span>
            <span id="earnings-weekly-usd" style="font-weight: 600">‚Äî</span>
          </div>
          <div class="subtext" style="margin-top: 6px">
            <span style="opacity: 0.7">RXD/day:</span>
            <span id="earnings-rxd-coins" style="font-weight: 600">‚Äî</span>
          </div>
          <div class="subtext" style="margin-top: 6px; font-size: 0.65em">
            Updated: <span id="earnings-timestamp">‚Äî</span>
          </div>
        </div>

        <div class="stat-card rxd-price-card" title="Current RXD market price from CoinGecko" id="price-card" style="display: none">
          <h3>
            <img src="/static/radiant-logo.png" alt="RXD" class="chain-logo" onerror="this.style.display='none'" />
            RXD Price
          </h3>
          <div class="value" id="price-usd" style="font-size: 1.8em">‚Äî</div>
          <div class="unit">USD</div>
          <div class="subtext" style="margin-top: 8px">
            <span style="opacity: 0.7">BTC:</span>
            <span id="price-btc" style="font-weight: 600">‚Äî</span>
          </div>
          <div class="subtext" style="margin-top: 6px; font-size: 0.65em">
            Updated: <span id="price-timestamp">‚Äî</span>
          </div>
        </div>

        <div class="stat-card rxd-network-card" title="Current RXD blockchain height">
          <h3>
            <img src="/static/radiant-logo.png" alt="RXD" class="chain-logo" onerror="this.style.display='none'" />
            RXD Network
          </h3>
          <div class="value" id="rxd-height" style="font-size: 1.8em">‚Äî</div>
          <div class="unit">Block Height</div>
        </div>

        <div class="stat-card rxd-difficulty-card" title="Current RXD network target difficulty">
          <h3>
            <img src="/static/radiant-logo.png" alt="RXD" class="chain-logo" onerror="this.style.display='none'" />
            RXD Difficulty
          </h3>
          <div class="value" id="rxd-difficulty" style="font-size: 1.8em">‚Äî</div>
          <div class="unit">Target Difficulty</div>
        </div>
      </div>

      <div class="toolbar">
        <label class="worker-toggle" style="display: flex; align-items: center; gap: 8px; font-size: 0.8em; letter-spacing: 0.5px; opacity: 0.85; cursor: pointer;">
          <input type="checkbox" id="worker-mode-toggle" checked style="accent-color: #05a532; width: 16px; height: 16px; cursor: pointer;" />
          <span>Compact worker names</span>
        </label>
        <span style="font-size: 0.7em; opacity: 0.55">(Toggle to show full wallet.worker identifiers)</span>
        <div class="maintenance-group" aria-label="Maintenance actions">
          <button id="flush-hashrate" class="toolbar-btn" title="Clear rolling window + EMA so fresh hashrate accumulates">Flush Hashrate Window</button>
        </div>
      </div>

      <div class="explorers" aria-label="Explorer quick links">
        <a href="https://radiantexplorer.com/" target="_blank" rel="noopener" title="Radiant Explorer Home"><span class="chain-tag">RXD</span>Explorer</a>
      </div>

      <!-- Daemon Status Section -->
      <div class="section">
        <h2 style="cursor: pointer; user-select: none" onclick="toggleDaemonStatus()">
          <span id="daemon-toggle-icon">‚ñº</span> Blockchain Daemon Status
        </h2>
        <div id="daemon-status-content">
          <div class="stats-grid" style="margin-top: 16px">
            <div class="stat-card rxd-network-card">
              <h3>
                <img src="/static/radiant-logo.png" alt="RXD" class="chain-logo" onerror="this.style.display='none'" />
                Radiant Node
              </h3>
              <div style="margin-top: 12px; font-size: 0.85em; line-height: 1.6">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="opacity: 0.7">Status:</span>
                  <span id="rxd-daemon-status" style="font-weight: 600">‚Äî</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="opacity: 0.7">Sync:</span>
                  <span id="rxd-sync-progress" style="font-weight: 600">‚Äî</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="opacity: 0.7">Connections:</span>
                  <span id="rxd-connections" style="font-weight: 600">‚Äî</span>
                </div>
                <div style="display: flex; justify-content: space-between">
                  <span style="opacity: 0.7">Version:</span>
                  <span id="rxd-version" style="font-weight: 600">‚Äî</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>
          <span class="live-indicator"></span>Active Miners
          <span id="vardiff-badge" class="badge" style="display: none; margin-left: 12px; font-size: 0.6em; padding: 4px 10px; background: #057c32; color: #fff; vertical-align: middle;" title="Variable difficulty is enabled">VarDiff: Enabled</span>
        </h2>
        <div class="table-wrapper">
          <table id="miners-table" aria-label="Active Miners">
            <thead>
              <tr>
                <th>Worker</th>
                <th>Software</th>
                <th class="col-num">Difficulty</th>
                <th class="col-num">Hashrate</th>
                <th class="col-num">Share Intvl</th>
                <th class="col-num">Uptime</th>
              </tr>
            </thead>
            <tbody id="miners-body">
              <tr><td colspan="6" class="no-data">Loading...</td></tr>
            </tbody>
          </table>
        </div>
        <div id="miners-pagination" class="pagination-controls" style="margin-top: 12px">
          <button id="miners-prev-btn" class="pagination-btn" onclick="minersPaginationState.page = Math.max(1, minersPaginationState.page - 1); saveMinersPaginationState(); updateMiners()">‚Üê Previous</button>
          <span id="miners-page-info" style="margin: 0 12px">Page 1 of 1</span>
          <button id="miners-next-btn" class="pagination-btn" onclick="minersPaginationState.page += 1; saveMinersPaginationState(); updateMiners()">Next ‚Üí</button>
        </div>
      </div>

      <div class="section" id="section-recently-seen-miners">
        <h2>Recently Seen Miners</h2>
        <div style="margin-bottom: 12px">
          <label for="disconnected-miners-hours">Time Range:</label>
          <select id="disconnected-miners-hours" onchange="updateDisconnectedMiners()" style="margin-left: 8px; padding: 4px 8px">
            <option value="24">Last 24 hours</option>
            <option value="168">Last 7 days</option>
            <option value="720">Last 30 days</option>
          </select>
        </div>
        <div class="table-wrapper">
          <table aria-label="Recently Disconnected Miners">
            <thead>
              <tr>
                <th>Worker</th>
                <th>Software</th>
                <th>Time Ago</th>
                <th>Last Seen</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="disconnected-miners-body">
              <tr><td colspan="5" class="no-data">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <h2>Recent Blocks</h2>
        <div style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <button id="export-json-btn" class="toolbar-btn export-btn" style="font-size: 0.9em" title="Download all blocks as JSON">JSON</button>
          <button id="export-csv-btn" class="toolbar-btn export-btn" style="font-size: 0.9em" title="Download all blocks as CSV">CSV</button>
          <span id="export-status" style="font-size: 0.85em; opacity: 0.6; display: none"></span>
        </div>
        <div class="subsection rxd-blocks-card">
          <h3 style="margin: 0 0 10px 0; display: flex; align-items: center; gap: 6px; font-size: 1em;">
            <span class="badge badge-rxd"><img src="/static/radiant-logo.png" alt="" class="chain-logo" onerror="this.style.display='none'" />RXD</span>
            <span style="opacity: 0.75; font-weight: 500">Blocks</span>
          </h3>
          <div class="table-wrapper">
            <table id="rxd-blocks-table" aria-label="Recent RXD Blocks">
              <thead>
                <tr>
                  <th class="col-num">Height</th>
                  <th>Block Hash</th>
                  <th>Worker</th>
                  <th class="col-status">Status</th>
                  <th class="col-num">Time</th>
                </tr>
              </thead>
              <tbody id="rxd-blocks-body">
                <tr><td colspan="5" class="no-data">Loading...</td></tr>
              </tbody>
            </table>
          </div>
          <div id="rxd-pagination" class="pagination-controls" style="display: none; margin-top: 12px; text-align: center; font-size: 0.85em;">
            <button class="pagination-btn" onclick="prevBlocksPage()" title="Previous page">‚Üê Prev</button>
            <span id="rxd-page-info" style="margin: 0 12px; opacity: 0.7">Page 1</span>
            <button class="pagination-btn" onclick="nextBlocksPage()" title="Next page">Next ‚Üí</button>
          </div>
        </div>
      </div>

      <div class="section" id="section-difficulty-chart">
        <h2>Network Difficulty Trend</h2>
        <div style="position: relative; height: 300px; margin-bottom: 20px">
          <canvas id="difficulty-chart"></canvas>
        </div>
        <div style="display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
          <button id="difficulty-24h-btn" class="toolbar-btn active-chart-btn" onclick="updateDifficultyChart(24)" title="Last 24 hours">24h</button>
          <button id="difficulty-7d-btn" class="toolbar-btn" onclick="updateDifficultyChart(168)" title="Last 7 days">7d</button>
          <button id="difficulty-30d-btn" class="toolbar-btn" onclick="updateDifficultyChart(720)" title="Last 30 days">30d</button>
        </div>
      </div>

      <div class="section" id="section-hashrate-chart">
        <h2>Hashrate History Graph</h2>
        <div style="position: relative; height: 300px; margin-bottom: 20px">
          <canvas id="hashrate-chart"></canvas>
        </div>
        <div style="display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
          <button id="hashrate-24h-btn" class="toolbar-btn active-chart-btn" onclick="updateHashrateChart(24)" title="Last 24 hours">24h</button>
          <button id="hashrate-7d-btn" class="toolbar-btn" onclick="updateHashrateChart(168)" title="Last 7 days">7d</button>
          <button id="hashrate-30d-btn" class="toolbar-btn" onclick="updateHashrateChart(720)" title="Last 30 days">30d</button>
        </div>
      </div>

      <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h2>Best Shares</h2>
          <button id="clear-best-shares" class="toolbar-btn" title="Clear all best shares and start tracking fresh" style="margin: 0; font-size: 0.9em">Clear</button>
        </div>
        <div class="table-wrapper">
          <table id="best-shares-table" aria-label="Best Shares">
            <thead>
              <tr>
                <th class="col-num">Rank</th>
                <th>Difficulty</th>
                <th>RXD Ratio</th>
                <th>Worker</th>
                <th class="col-num">Time</th>
              </tr>
            </thead>
            <tbody id="best-shares-body">
              <tr><td colspan="5" class="no-data">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <h2>Payout Address</h2>
        <div class="table-wrapper">
          <table aria-label="Payout Addresses">
            <thead>
              <tr>
                <th>Chain</th>
                <th>Address</th>
                <th>Source</th>
              </tr>
            </thead>
            <tbody id="payouts-body">
              <tr><td colspan="3" class="no-data">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="status-bar" id="status-bar" style="margin-top: 30px; padding: 16px 24px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; display: flex; flex-wrap: wrap; gap: 24px; align-items: center; font-size: 0.85em; border: 1px solid rgba(255, 255, 255, 0.1);">
        <div style="font-weight: 600; opacity: 0.7; margin-right: 8px">System Configuration:</div>
        <div id="status-vardiff" class="status-item" style="display: none">
          <span style="color: #05a532; margin-right: 4px">‚óè</span>
          <span title="Variable difficulty is enabled">VarDiff</span>
          <span class="status-detail" style="opacity: 0.6; margin-left: 6px; font-size: 0.9em"></span>
        </div>
        <div id="status-zmq" class="status-item" style="display: none">
          <span style="color: #05a532; margin-right: 4px">‚óè</span>
          <span title="ZeroMQ block notifications enabled">ZMQ</span>
        </div>
        <div id="status-notifications" class="status-item" style="display: none">
          <span style="color: #05a532; margin-right: 4px">‚óè</span>
          <span>Notifications</span>
          <span class="status-detail" style="opacity: 0.6; margin-left: 6px; font-size: 0.9em"></span>
        </div>
        <div id="status-database" class="status-item" style="display: none">
          <span style="color: #05a532; margin-right: 4px">‚óè</span>
          <span title="Database logging enabled">Database</span>
        </div>
        <div id="status-stratum" class="status-item" style="display: none">
          <span style="color: #05a532; margin-right: 4px">‚óè</span>
          <span title="Stratum server port">Port:</span>
          <span class="status-detail" style="margin-left: 4px; font-weight: 500">‚Äî</span>
        </div>
        <div id="status-loading" style="opacity: 0.5; font-style: italic">Loading configuration...</div>
      </div>

      <div class="update-time">Last updated: <span id="last-update">Never</span></div>
    </div>

    <script>
      // Theme toggle
      (function createFloatingThemeToggle() {
        const fab = document.createElement("button");
        fab.id = "theme-toggle";
        fab.className = "theme-toggle-fab";
        fab.innerHTML = '<span class="icon" aria-hidden="true">üåô</span><span class="label">Light Mode</span>';
        document.body.appendChild(fab);
      })();

      function formatHashrate(miner) {
        if (miner.hashrate_display) return miner.hashrate_display;
        const mhs = miner.hashrate_mhs || 0;
        if (mhs === 0) return "0.00 H/s";
        if (mhs >= 1000) return (mhs / 1000).toFixed(2) + " GH/s";
        return mhs.toFixed(2) + " MH/s";
      }

      function formatUptime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        if (hours > 0) return `${hours}h ${minutes}m`;
        else if (minutes > 0) return `${minutes}m ${secs}s`;
        return `${secs}s`;
      }

      function formatTime(timestamp) {
        const date = new Date(timestamp * 1000);
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);
        if (diff < 60) return `${diff}s ago`;
        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
        return `${Math.floor(diff / 86400)}d ago`;
      }

      function shortenHash(hash) {
        if (!hash) return "";
        if (hash.length <= 20) return hash;
        return hash.substring(0, 10) + "..." + hash.substring(hash.length - 10);
      }

      function formatDifficulty(difficulty) {
        if (!difficulty || difficulty === 0) return "‚Äî";
        if (difficulty >= 1_000_000_000) return (difficulty / 1_000_000_000).toFixed(2) + " G";
        if (difficulty >= 1_000_000) return (difficulty / 1_000_000).toFixed(2) + " M";
        if (difficulty >= 1_000) return (difficulty / 1_000).toFixed(2) + " K";
        return difficulty.toFixed(8);
      }

      function formatRatio(ratio) {
        if (!ratio || ratio <= 0) return "-";
        if (ratio < 0.01) {
          const inverse = Math.round(1 / ratio);
          if (inverse >= 1000000) return `1 in ${(inverse / 1000000).toFixed(1)}M`;
          else if (inverse >= 1000) return `1 in ${(inverse / 1000).toFixed(0)}K`;
          else return `1 in ${inverse}`;
        }
        return `${ratio.toFixed(2)}x`;
      }

      function copyToClipboard(text, button) {
        if (!navigator.clipboard) {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          try { document.execCommand("copy"); } catch (e) {}
          document.body.removeChild(ta);
        } else {
          navigator.clipboard.writeText(text).catch(() => {});
        }
        if (button) {
          button.classList.add("copied");
          const original = button.textContent;
          button.textContent = "Copied";
          setTimeout(() => { button.classList.remove("copied"); button.textContent = original; }, 1200);
        }
      }

      function toggleDaemonStatus() {
        const content = document.getElementById("daemon-status-content");
        const icon = document.getElementById("daemon-toggle-icon");
        if (!content || !icon) return;
        if (content.style.display === "none") { content.style.display = "grid"; icon.textContent = "‚ñº"; }
        else { content.style.display = "none"; icon.textContent = "‚ñ∂"; }
      }

      async function updateDaemonStatus() {
        try {
          const response = await fetch("/api/daemon-status");
          if (!response.ok) throw new Error("Failed to fetch daemon status");
          const data = await response.json();
          updateDaemonCard("rxd", data.rxd);
        } catch (error) {
          console.error("Error updating daemon status:", error);
          const statusEl = document.getElementById("rxd-daemon-status");
          if (statusEl) statusEl.textContent = "Error";
        }
      }

      function updateDaemonCard(chain, info) {
        if (!info) return;
        const statusEl = document.getElementById(`${chain}-daemon-status`);
        if (statusEl) {
          statusEl.textContent = info.status || "‚Äî";
          if (info.status === "Connected") statusEl.style.color = "#2ecc71";
          else if (info.status === "Timeout" || info.status === "Offline") statusEl.style.color = "#ff6b6b";
          else statusEl.style.color = "#f1c40f";
        }
        const syncEl = document.getElementById(`${chain}-sync-progress`);
        if (syncEl) {
          if (info.status === "Connected") syncEl.textContent = `${info.sync || "‚Äî"} (${info.blocks || 0} blocks)`;
          else syncEl.textContent = "‚Äî";
        }
        const connEl = document.getElementById(`${chain}-connections`);
        if (connEl) connEl.textContent = info.connections !== undefined ? `${info.connections}` : "‚Äî";
        const versionEl = document.getElementById(`${chain}-version`);
        if (versionEl) versionEl.textContent = info.version || "‚Äî";
      }

      let workerCompactMode = true;
      function displayWorker(full) {
        if (!full) return "";
        if (!workerCompactMode) return full;
        if (full.includes(".")) {
          const parts = full.split(".");
          for (let i = parts.length - 1; i >= 0; i--) { if (parts[i]) return parts[i]; }
        }
        return full;
      }

      function formatDate(date) { return date.toLocaleDateString() + " " + date.toLocaleTimeString(); }

      function getTimeAgo(date) {
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);
        const MINUTE = 60, HOUR = 60 * MINUTE, DAY = 24 * HOUR;
        if (diff < MINUTE) return "just now";
        else if (diff < HOUR) return `${Math.floor(diff / MINUTE)}m ago`;
        else if (diff < DAY) return `${Math.floor(diff / HOUR)}h ago`;
        else return `${Math.floor(diff / DAY)}d ago`;
      }

      function formatTTF(seconds) {
        if (!seconds || seconds <= 0) return "‚Äî";
        const MINUTE = 60, HOUR = 60 * MINUTE, DAY = 24 * HOUR, WEEK = 7 * DAY, MONTH = 30 * DAY;
        if (seconds < MINUTE) return `${Math.round(seconds)}s`;
        else if (seconds < HOUR) return `${(seconds / MINUTE).toFixed(1)}m`;
        else if (seconds < DAY) return `${(seconds / HOUR).toFixed(1)}h`;
        else if (seconds < WEEK) return `${(seconds / DAY).toFixed(1)}d`;
        else if (seconds < MONTH) return `${(seconds / WEEK).toFixed(1)}w`;
        else return `${(seconds / MONTH).toFixed(1)}mo`;
      }

      const minersPaginationState = { page: 1, limit: 20, total: 0, miners: [] };

      function loadMinersPaginationState() {
        try { const saved = localStorage.getItem("minersPaginationPage"); if (saved) minersPaginationState.page = parseInt(saved) || 1; } catch (e) {}
      }
      function saveMinersPaginationState() {
        try { localStorage.setItem("minersPaginationPage", minersPaginationState.page); } catch (e) {}
      }

      async function updateMiners() {
        try {
          loadMinersPaginationState();
          const response = await fetch("/api/miners");
          const data = await response.json();
          minersPaginationState.miners = data.miners || [];
          minersPaginationState.total = minersPaginationState.miners.length;
          const totalPages = Math.ceil(minersPaginationState.miners.length / minersPaginationState.limit) || 1;
          if (minersPaginationState.page > totalPages) { minersPaginationState.page = Math.max(1, totalPages); saveMinersPaginationState(); }
          const offset = (minersPaginationState.page - 1) * minersPaginationState.limit;
          const pageMiners = minersPaginationState.miners.slice(offset, offset + minersPaginationState.limit);
          const vardiffBadge = document.getElementById("vardiff-badge");
          if (vardiffBadge) vardiffBadge.style.display = data.vardiff_enabled ? "inline-block" : "none";
          const instantMode = document.getElementById("mode-toggle-hashrate").checked;
          let displayStr = instantMode ? (data.total_instant_display || data.total_hashrate_display) : (data.total_ema_display || data.total_hashrate_display);
          if (displayStr) { const parts = displayStr.split(" "); document.getElementById("total-hashrate").textContent = parts[0]; document.getElementById("total-hashrate-unit").textContent = parts[1] || "H/s"; }
          const relErr = data.total_rel_error_est ?? 1.0;
          const sharesWin = data.total_shares_in_window ?? 0;
          const confEl = document.getElementById("total-hashrate-conf");
          if (sharesWin > 0) { const pct = (relErr * 100).toFixed(relErr * 100 >= 10 ? 1 : 2); confEl.textContent = `¬±${pct}%`; confEl.style.display = "inline-block"; let bg; if (relErr < 0.05) bg = "#057c32"; else if (relErr < 0.15) bg = "#a66b00"; else bg = "#a60000"; confEl.style.background = bg; } else confEl.style.display = "none";
          document.getElementById("hashrate-subtext").textContent = instantMode ? "Instant window-based aggregate hashrate" : "EMA-smoothed aggregate hashrate";
          document.getElementById("miner-count").textContent = data.miner_count;
          const tbody = document.getElementById("miners-body");
          if (pageMiners.length === 0) tbody.innerHTML = '<tr><td colspan="6" class="no-data">No miners connected</td></tr>';
          else tbody.innerHTML = pageMiners.map((miner) => {
            const diffCell = miner.assigned_difficulty != null ? miner.assigned_difficulty.toFixed(8) : "‚Äî";
            let shareIntvlDisplay = "‚Äî";
            if (miner.share_blended_interval != null && miner.share_blended_interval > 0 && miner.target_interval) {
              const blended = miner.share_blended_interval, target = miner.target_interval, pct = (blended / target) * 100;
              shareIntvlDisplay = `${blended.toFixed(1)}s<br/><span style="opacity:.7;font-size:.7em">${pct.toFixed(0)}%</span>`;
            }
            return `<tr><td title="${miner.worker}">${displayWorker(miner.worker)}</td><td>${miner.software || ""}</td><td class="col-num">${diffCell}</td><td class="col-num">${formatHashrate(miner)}</td><td class="col-num">${shareIntvlDisplay}</td><td class="col-num">${formatUptime(miner.uptime_seconds || 0)}</td></tr>`;
          }).join("");
          updateMinersPaginationControls();
        } catch (error) { console.error("Error fetching miners:", error); }
      }

      function updateMinersPaginationControls() {
        const totalPages = Math.ceil(minersPaginationState.miners.length / minersPaginationState.limit) || 1;
        const pageInfo = document.getElementById("miners-page-info");
        if (pageInfo) pageInfo.textContent = `Page ${minersPaginationState.page} of ${totalPages}`;
        const prevBtn = document.getElementById("miners-prev-btn"), nextBtn = document.getElementById("miners-next-btn");
        if (prevBtn) prevBtn.disabled = minersPaginationState.page <= 1;
        if (nextBtn) nextBtn.disabled = minersPaginationState.page >= totalPages;
      }

      async function updateDisconnectedMiners() {
        try {
          const hours = parseInt(document.getElementById("disconnected-miners-hours")?.value || "24");
          const response = await fetch(`/api/miners/disconnected?hours=${hours}&page=1&limit=50`);
          const data = await response.json();
          const tbody = document.getElementById("disconnected-miners-body");
          if (data.miners.length === 0) tbody.innerHTML = '<tr><td colspan="5" class="no-data">No recently disconnected miners</td></tr>';
          else tbody.innerHTML = data.miners.map((miner) => {
            const lastSeen = new Date(miner.last_seen * 1000), timeAgo = getTimeAgo(lastSeen);
            return `<tr><td title="${miner.worker_name}">${displayWorker(miner.worker_name)}</td><td>${miner.miner_software || "Unknown"}</td><td>${timeAgo}</td><td>${formatDate(lastSeen)}</td><td><button class="action-btn" onclick="clearMinerRecord('${miner.worker_name.replace(/'/g, "\\'")}')">Clear</button></td></tr>`;
          }).join("");
        } catch (error) { console.error("Error fetching disconnected miners:", error); }
      }

      async function clearMinerRecord(workerName) {
        const confirmed = await showConfirmModal("Delete Miner Record", `Are you sure you want to delete the record for "${workerName}"?`, "Delete", "Cancel");
        if (!confirmed) return;
        try { const response = await fetch(`/api/miners/${encodeURIComponent(workerName)}/clear`, { method: "POST" }); if (response.ok) { await updateDisconnectedMiners(); showNotification(`Cleared record for ${workerName}`); } else showNotification(`Failed to clear record for ${workerName}`, "error"); } catch (error) { console.error("Error clearing miner record:", error); showNotification("Error clearing miner record", "error"); }
      }

      async function updateStats() {
        try {
          const response = await fetch("/api/stats");
          const data = await response.json();
          document.getElementById("rxd-blocks").textContent = data.blocks?.RXD || 0;
          if (data.blocks_all_time) { const el = document.getElementById("rxd-blocks-alltime"); if (el) el.textContent = "All time: " + (data.blocks_all_time.RXD || 0).toLocaleString(); }
          document.getElementById("acceptance-rate").textContent = data.acceptance_rate !== null ? data.acceptance_rate.toFixed(2) : "‚Äî";
          document.getElementById("total-shares").textContent = data.total_shares.toLocaleString();
          try {
            const height = data.current_height_rxd, diff = data.current_rxd_difficulty;
            const heightEl = document.getElementById("rxd-height"), diffEl = document.getElementById("rxd-difficulty");
            if (heightEl && height != null) { heightEl.textContent = height; heightEl.title = `RXD blockchain height: ${height}`; }
            if (diffEl && diff != null) { diffEl.textContent = diff.toFixed(8); diffEl.title = `RXD network difficulty: ${diff}`; }
          } catch (e) {}
          if (data.shares_since_last_block != null) {
            document.getElementById("shares-since-block").textContent = data.shares_since_last_block.toLocaleString();
            if (data.last_block_time) { const ageSec = Math.max(0, Math.floor(Date.now() / 1000 - data.last_block_time)); let ageStr; if (ageSec < 60) ageStr = ageSec + "s"; else if (ageSec < 3600) ageStr = Math.floor(ageSec / 60) + "m"; else if (ageSec < 86400) ageStr = Math.floor(ageSec / 3600) + "h"; else ageStr = Math.floor(ageSec / 86400) + "d"; document.getElementById("shares-since-block-age").textContent = ageStr; }
            else document.getElementById("shares-since-block-age").textContent = "‚Äî";
          } else { document.getElementById("shares-since-block").textContent = "‚Äî"; document.getElementById("shares-since-block-age").textContent = "‚Äî"; }
          const ttfRxdEl = document.getElementById("ttf-rxd"), ttfRxd12hEl = document.getElementById("ttf-rxd-12h"), ttfRxd24hEl = document.getElementById("ttf-rxd-24h");
          if (ttfRxdEl) { ttfRxdEl.textContent = formatTTF(data.ttf_rxd_seconds); ttfRxdEl.title = data.ttf_rxd_seconds ? `${Math.round(data.ttf_rxd_seconds).toLocaleString()} seconds` : "No hashrate data"; }
          if (ttfRxd12hEl) { ttfRxd12hEl.textContent = formatTTF(data.ttf_rxd_12h_seconds); ttfRxd12hEl.title = data.ttf_rxd_12h_seconds ? `${Math.round(data.ttf_rxd_12h_seconds).toLocaleString()} seconds (12h avg)` : "No history data"; }
          if (ttfRxd24hEl) { ttfRxd24hEl.textContent = formatTTF(data.ttf_rxd_24h_seconds); ttfRxd24hEl.title = data.ttf_rxd_24h_seconds ? `${Math.round(data.ttf_rxd_24h_seconds).toLocaleString()} seconds (24h avg)` : "No history data"; }
        } catch (error) { console.error("Error fetching stats:", error); }
      }

      const blocksPaginationState = { rxd: { all: [], page: 1, perPage: 5, total: 0, lastSeenTotal: 0 } };

      function loadPaginationState() { try { const saved = localStorage.getItem("blocksPaginationPage"); if (saved) blocksPaginationState.rxd.page = parseInt(saved) || 1; } catch (e) {} }
      function savePaginationState() { try { localStorage.setItem("blocksPaginationPage", blocksPaginationState.rxd.page.toString()); } catch (e) {} }

      async function updateBlocks() {
        try {
          const page = blocksPaginationState.rxd.page, perPage = 5, offset = (page - 1) * perPage;
          const response = await fetch(`/api/blocks/rxd?limit=${perPage}&offset=${offset}`);
          const data = await response.json();
          const blocks = data.blocks || [];
          blocks.forEach((block) => { if (block.confirmations === undefined || block.confirmations === null) block.confirmations = 0; if (!block.confirmation_status) block.confirmation_status = "unknown"; if (block.is_orphaned === undefined || block.is_orphaned === null) block.is_orphaned = false; });
          if (blocksPaginationState.rxd.lastSeenTotal > 0 && data.total > blocksPaginationState.rxd.lastSeenTotal) { const newBlocksCount = data.total - blocksPaginationState.rxd.lastSeenTotal; showNotification(`üéâ ${newBlocksCount} new RXD block${newBlocksCount > 1 ? "s" : ""} found!`); }
          blocksPaginationState.rxd.all = blocks; blocksPaginationState.rxd.total = data.total; blocksPaginationState.rxd.lastSeenTotal = data.total;
          renderBlocksPage();
        } catch (error) { console.error("Error fetching blocks:", error); document.getElementById("rxd-blocks-body").innerHTML = '<tr><td colspan="5" class="no-data">Error</td></tr>'; }
      }

      function renderBlocksPage() {
        const state = blocksPaginationState.rxd, tbody = document.getElementById("rxd-blocks-body"), paginationDiv = document.getElementById("rxd-pagination"), pageInfo = document.getElementById("rxd-page-info");
        const blocks = state.all, page = state.page, totalCount = state.total, perPage = 5, totalPages = Math.ceil(totalCount / perPage);
        function renderBlockRow(block) {
          const absTime = new Date(block.timestamp * 1000).toISOString(), explorerBase = "https://radiantexplorer.com/block/";
          let statusBadgeClass = "badge-accepted", statusText = block.accepted ? "Accepted" : "Rejected";
          if (block.is_orphaned) { statusBadgeClass = "badge-orphaned"; statusText = "Orphaned"; }
          else if (block.confirmation_status === "confirmed" || block.confirmations >= 100) { statusBadgeClass = "badge-confirmed"; statusText = "Confirmed"; }
          else if (block.confirmation_status === "pending" || block.confirmations > 0) { statusBadgeClass = "badge-pending"; statusText = "Confirming"; }
          else if (block.confirmation_status === "unknown") { statusBadgeClass = "badge-unknown"; statusText = "Unknown"; }
          let confirmationsDisplay = "‚Äî";
          if (block.confirmations !== undefined && block.confirmations !== null) { confirmationsDisplay = block.confirmations.toLocaleString(); if (block.confirmations >= 100) confirmationsDisplay += " ‚úì"; }
          let statusTooltip = `Confirmations: ${confirmationsDisplay}`;
          if (block.is_orphaned) statusTooltip = `Orphaned block`;
          return `<tr><td class="col-num">${block.height}</td><td class="hash-short"><div class="copy-wrap" title="${block.block_hash}"><a class="hash-link" href="${explorerBase + block.block_hash}" target="_blank" rel="noopener">${shortenHash(block.block_hash)}</a><button class="copy-btn" onclick="copyToClipboard('${block.block_hash}', this)">Copy</button></div></td><td title="${block.worker}">${displayWorker(block.worker)}</td><td class="col-status"><span class="badge ${statusBadgeClass}" title="${statusTooltip}">${statusText}</span></td><td class="col-num" title="${absTime}">${formatTime(block.timestamp)}</td></tr>`;
        }
        if (blocks.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="no-data">No RXD blocks yet</td></tr>'; paginationDiv.style.display = "none"; }
        else {
          tbody.innerHTML = blocks.map(renderBlockRow).join("");
          if (totalPages > 1) { paginationDiv.style.display = "flex"; pageInfo.textContent = `Page ${page} of ${totalPages}`; const prevBtn = paginationDiv.querySelector('[onclick*="prevBlocksPage"]'), nextBtn = paginationDiv.querySelector('[onclick*="nextBlocksPage"]'); if (prevBtn) prevBtn.disabled = page === 1; if (nextBtn) nextBtn.disabled = page === totalPages; }
          else paginationDiv.style.display = "none";
        }
      }

      function prevBlocksPage() { if (blocksPaginationState.rxd.page > 1) { blocksPaginationState.rxd.page--; savePaginationState(); updateBlocks(); } }
      function nextBlocksPage() { const state = blocksPaginationState.rxd, perPage = 5, totalPages = Math.ceil(state.total / perPage); if (state.page < totalPages) { state.page++; savePaginationState(); updateBlocks(); } }

      async function updateBestShares() {
        try {
          const response = await fetch("/api/best-shares");
          const data = await response.json();
          const tbody = document.getElementById("best-shares-body");
          function renderBestShareRow(share, index) {
            const absTime = new Date(share.timestamp * 1000).toLocaleString();
            let workerName = share.worker;
            if (share.worker.includes(".")) workerName = share.worker.split(".").pop();
            else workerName = share.worker.substring(0, 8);
            let rankDisplay = (index + 1).toString(), rankClass = "";
            if (index === 0) { rankDisplay = "ü•á"; rankClass = "rank-gold"; }
            else if (index === 1) { rankDisplay = "ü•à"; rankClass = "rank-silver"; }
            else if (index === 2) { rankDisplay = "ü•â"; rankClass = "rank-bronze"; }
            const rxdRatio = formatRatio(share.rxd_ratio);
            return `<tr><td class="col-num ${rankClass}">${rankDisplay}</td><td title="${share.share_difficulty}">${formatDifficulty(share.share_difficulty)}</td><td title="RXD target ratio" class="ratio-rxd">${rxdRatio}</td><td class="worker-name" title="${share.worker}"><span class="worker-text">${workerName}</span></td><td class="col-num" title="${absTime}">${formatTime(share.timestamp)}</td></tr>`;
          }
          tbody.innerHTML = data.shares?.length ? data.shares.map(renderBestShareRow).join("") : '<tr><td colspan="5" class="no-data">No shares yet</td></tr>';
        } catch (error) { console.error("Error fetching best shares:", error); document.getElementById("best-shares-body").innerHTML = '<tr><td colspan="5" class="no-data">Error loading best shares</td></tr>'; }
      }

      async function updatePayouts() {
        try {
          const response = await fetch("/api/payouts");
          const data = await response.json();
          const tbody = document.getElementById("payouts-body");
          if (!data.addresses || data.addresses.length === 0) { tbody.innerHTML = '<tr><td colspan="3" class="no-data">No payout addresses configured</td></tr>'; return; }
          tbody.innerHTML = data.addresses.map((addr) => {
            const explorerUrl = "https://radiantexplorer.com/address/" + addr.address;
            return `<tr><td><span class="badge badge-rxd">${addr.chain}</span></td><td class="addr-cell"><div class="copy-wrap" title="${addr.address}"><a class="hash-link" href="${explorerUrl}" target="_blank" rel="noopener">${addr.address}</a><button class="copy-btn" onclick="copyToClipboard('${addr.address}', this)">Copy</button></div></td><td>${addr.source}</td></tr>`;
          }).join("");
        } catch (error) { console.error("Error fetching payouts:", error); document.getElementById("payouts-body").innerHTML = '<tr><td colspan="3" class="no-data">Error loading payout addresses</td></tr>'; }
      }

      async function updateEarnings() {
        try {
          const response = await fetch("/api/earnings");
          const data = await response.json();
          const earningsCard = document.getElementById("earnings-card"), priceCard = document.getElementById("price-card");
          if (data.rxd && data.rxd.price_usd > 0) {
            earningsCard.style.display = "block"; priceCard.style.display = "block";
            document.getElementById("earnings-daily-usd").textContent = "$" + data.rxd.daily_usd_24h.toFixed(4);
            document.getElementById("earnings-weekly-usd").textContent = "$" + (data.rxd.daily_usd_24h * 7).toFixed(4);
            document.getElementById("earnings-rxd-coins").textContent = data.rxd.daily_coins_24h.toFixed(4);
            document.getElementById("earnings-timestamp").textContent = new Date().toLocaleTimeString();
            document.getElementById("price-usd").textContent = "$" + data.rxd.price_usd.toFixed(6);
            document.getElementById("price-btc").textContent = data.rxd.price_btc?.toFixed(10) || "‚Äî";
            document.getElementById("price-timestamp").textContent = new Date().toLocaleTimeString();
          } else { earningsCard.style.display = "none"; priceCard.style.display = "none"; }
        } catch (error) { console.error("Error fetching earnings:", error); }
      }

      async function updateConfig() {
        try {
          const response = await fetch("/api/config");
          const data = await response.json();
          document.getElementById("status-loading").style.display = "none";
          if (data.vardiff?.enabled) { const el = document.getElementById("status-vardiff"); el.style.display = "flex"; el.querySelector(".status-detail").textContent = `(target ${data.vardiff.target_share_time}s)`; }
          if (data.zmq?.enabled) document.getElementById("status-zmq").style.display = "flex";
          if (data.notifications?.discord || data.notifications?.telegram) { const el = document.getElementById("status-notifications"); el.style.display = "flex"; const channels = []; if (data.notifications.discord) channels.push("Discord"); if (data.notifications.telegram) channels.push("Telegram"); el.querySelector(".status-detail").textContent = `(${channels.join(", ")})`; }
          if (data.database?.enabled) document.getElementById("status-database").style.display = "flex";
          if (data.stratum_port) { const el = document.getElementById("status-stratum"); el.style.display = "flex"; el.querySelector(".status-detail").textContent = data.stratum_port; }
        } catch (error) { console.error("Error fetching config:", error); }
      }

      async function flushHashrate() { try { const response = await fetch("/api/hashrate/flush", { method: "POST" }); if (response.ok) { showNotification("Hashrate window flushed successfully"); await updateMiners(); } else showNotification("Failed to flush hashrate window", "error"); } catch (error) { console.error("Error flushing hashrate:", error); showNotification("Error flushing hashrate window", "error"); } }

      async function clearBestShares() {
        const confirmed = await showConfirmModal("Clear Best Shares", "Are you sure you want to clear all best shares? This cannot be undone.", "Clear", "Cancel");
        if (!confirmed) return;
        try { const response = await fetch("/api/best-shares/clear", { method: "POST" }); if (response.ok) { showNotification("Best shares cleared successfully"); await updateBestShares(); } else showNotification("Failed to clear best shares", "error"); } catch (error) { console.error("Error clearing best shares:", error); showNotification("Error clearing best shares", "error"); }
      }

      function showNotification(message, type = "success") { const notification = document.createElement("div"); notification.className = `notification notification-${type}`; notification.textContent = message; document.body.appendChild(notification); setTimeout(() => { notification.classList.add("fade-out"); setTimeout(() => notification.remove(), 300); }, 3000); }

      // Theme toggle
      (function initThemeToggle() {
        const btn = document.getElementById("theme-toggle");
        if (!btn) return;
        const root = document.documentElement;
        const stored = localStorage.getItem("dashboardTheme");
        function setLabel() { const isLight = root.getAttribute("data-theme") === "light"; const iconSpan = btn.querySelector(".icon"); if (isLight) { btn.querySelector(".label")?.replaceChildren(document.createTextNode("Dark Mode")); if (iconSpan) iconSpan.textContent = "‚òÄÔ∏è"; } else { btn.querySelector(".label")?.replaceChildren(document.createTextNode("Light Mode")); if (iconSpan) iconSpan.textContent = "üåô"; } }
        if (stored === "light") root.setAttribute("data-theme", "light"); else root.removeAttribute("data-theme");
        setLabel();
        btn.addEventListener("click", () => { const isLight = root.getAttribute("data-theme") === "light"; document.body.classList.remove("theme-fade"); void document.body.offsetWidth; document.body.classList.add("theme-fade"); if (isLight) { root.removeAttribute("data-theme"); localStorage.setItem("dashboardTheme", "dark"); } else { root.setAttribute("data-theme", "light"); localStorage.setItem("dashboardTheme", "light"); } setLabel(); });
      })();

      document.getElementById("worker-mode-toggle")?.addEventListener("change", (e) => { workerCompactMode = e.target.checked; updateMiners(); updateBlocks(); updateBestShares(); updateDisconnectedMiners(); });
      document.getElementById("mode-toggle-hashrate")?.addEventListener("change", () => { updateMiners(); });
      document.getElementById("flush-hashrate")?.addEventListener("click", flushHashrate);
      document.getElementById("clear-best-shares")?.addEventListener("click", clearBestShares);

      let difficultyChart = null, hashrateChart = null, currentDifficultyHours = 24, currentHashrateHours = 24;

      function getChartColors() { const isLight = document.documentElement.getAttribute("data-theme") === "light"; return { rxdColor: "#0080ff", gridColor: isLight ? "rgba(0, 0, 0, 0.1)" : "rgba(255, 255, 255, 0.1)", textColor: isLight ? "#333" : "#ccc", legendColor: isLight ? "#333" : "#fff", backgroundColor: isLight ? "#f8f9fa" : "#1a1a2e" }; }

      async function updateDifficultyChart(hours) {
        currentDifficultyHours = hours;
        ["24h", "7d", "30d"].forEach((period) => { const btn = document.getElementById(`difficulty-${period}-btn`); if (btn) btn.classList.toggle("active-chart-btn", (period === "24h" && hours === 24) || (period === "7d" && hours === 168) || (period === "30d" && hours === 720)); });
        try {
          const response = await fetch(`/api/difficulty/history?hours=${hours}`);
          const data = await response.json();
          const colors = getChartColors();
          const labels = data.points.map((p) => { const date = new Date(p.timestamp * 1000); if (hours <= 24) return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }); else return date.toLocaleDateString([], { month: "short", day: "numeric" }); });
          const rxdDifficulties = data.points.map((p) => p.rxd_difficulty);
          const ctx = document.getElementById("difficulty-chart").getContext("2d");
          if (difficultyChart) difficultyChart.destroy();
          Chart.defaults.color = colors.legendColor;
          difficultyChart = new Chart(ctx, { type: "line", data: { labels: labels, datasets: [{ label: "RXD Difficulty", data: rxdDifficulties, borderColor: colors.rxdColor, backgroundColor: colors.rxdColor + "25", borderWidth: 2.5, fill: true, tension: 0.4, pointRadius: 2, pointBackgroundColor: colors.rxdColor }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, labels: { color: colors.legendColor } } }, scales: { y: { beginAtZero: false, grid: { color: colors.gridColor }, ticks: { color: colors.textColor } }, x: { grid: { color: colors.gridColor }, ticks: { color: colors.textColor, maxTicksLimit: 12 } } } } });
        } catch (error) { console.error("Error updating difficulty chart:", error); }
      }

      async function updateHashrateChart(hours) {
        currentHashrateHours = hours;
        ["24h", "7d", "30d"].forEach((period) => { const btn = document.getElementById(`hashrate-${period}-btn`); if (btn) btn.classList.toggle("active-chart-btn", (period === "24h" && hours === 24) || (period === "7d" && hours === 168) || (period === "30d" && hours === 720)); });
        try {
          const response = await fetch(`/api/hashrate/history?hours=${hours}`);
          const data = await response.json();
          const colors = getChartColors();
          const points = data.points || [];
          const labels = points.map((p) => { const date = new Date(p.timestamp * 1000); if (hours <= 24) return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }); else return date.toLocaleDateString([], { month: "short", day: "numeric" }); });
          const hashrates = points.map((p) => p.hashrate_khs);
          const avg = hashrates.length > 0 ? hashrates.reduce((a, b) => a + b, 0) / hashrates.length : 0;
          const ctx = document.getElementById("hashrate-chart").getContext("2d");
          if (hashrateChart) hashrateChart.destroy();
          Chart.defaults.color = colors.legendColor;
          hashrateChart = new Chart(ctx, { type: "line", data: { labels: labels, datasets: [{ label: "Hashrate (KH/s)", data: hashrates, borderColor: colors.rxdColor, backgroundColor: colors.rxdColor + "25", borderWidth: 2.5, fill: true, tension: 0.4, pointRadius: 2, pointBackgroundColor: colors.rxdColor }, { label: `Average (${avg.toFixed(2)} KH/s)`, data: new Array(labels.length).fill(avg), borderColor: colors.textColor, borderWidth: 1, borderDash: [5, 5], fill: false, pointRadius: 0, tension: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, labels: { color: colors.legendColor } } }, scales: { y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { color: colors.textColor, callback: function (value) { return value.toFixed(1) + " KH/s"; } } }, x: { grid: { color: colors.gridColor }, ticks: { color: colors.textColor, maxTicksLimit: 12 } } } } });
        } catch (error) { console.error("Error updating hashrate chart:", error); }
      }

      function showConfirmModal(title, message, confirmText = "Confirm", cancelText = "Cancel") {
        return new Promise((resolve) => {
          const modal = document.getElementById("confirmModal"), overlay = document.getElementById("modalOverlay"), titleEl = document.getElementById("modalTitle"), messageEl = document.getElementById("modalMessage"), confirmBtn = document.getElementById("modalConfirmBtn"), cancelBtn = document.getElementById("modalCancelBtn");
          titleEl.textContent = title; messageEl.textContent = message; confirmBtn.textContent = confirmText; cancelBtn.textContent = cancelText;
          const handleConfirm = () => { cleanup(); resolve(true); };
          const handleCancel = () => { cleanup(); resolve(false); };
          const cleanup = () => { modal.style.display = "none"; overlay.style.display = "none"; confirmBtn.removeEventListener("click", handleConfirm); cancelBtn.removeEventListener("click", handleCancel); overlay.removeEventListener("click", handleCancel); document.removeEventListener("keydown", handleEscape); };
          const handleEscape = (e) => { if (e.key === "Escape") handleCancel(); };
          confirmBtn.addEventListener("click", handleConfirm); cancelBtn.addEventListener("click", handleCancel); overlay.addEventListener("click", handleCancel); document.addEventListener("keydown", handleEscape);
          modal.style.display = "flex"; overlay.style.display = "block"; confirmBtn.focus();
        });
      }

      async function exportBlocks(format) {
        try {
          const statusEl = document.getElementById("export-status");
          statusEl.style.display = "inline"; statusEl.textContent = "Exporting...";
          const response = await fetch("/api/blocks/rxd?limit=10000");
          const data = await response.json();
          const blocks = data.blocks || [];
          let content, filename, mimeType;
          if (format === "json") { content = JSON.stringify(blocks, null, 2); filename = "rxd-blocks.json"; mimeType = "application/json"; }
          else { const headers = ["height", "block_hash", "worker", "accepted", "timestamp"]; const rows = blocks.map((b) => headers.map((h) => b[h] ?? "").join(",")); content = [headers.join(","), ...rows].join("\n"); filename = "rxd-blocks.csv"; mimeType = "text/csv"; }
          const blob = new Blob([content], { type: mimeType }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
          statusEl.textContent = `Exported ${blocks.length} blocks`; setTimeout(() => { statusEl.style.display = "none"; }, 3000);
        } catch (error) { console.error("Error exporting blocks:", error); const statusEl = document.getElementById("export-status"); statusEl.textContent = "Export failed"; setTimeout(() => { statusEl.style.display = "none"; }, 3000); }
      }

      document.getElementById("export-json-btn")?.addEventListener("click", () => exportBlocks("json"));
      document.getElementById("export-csv-btn")?.addEventListener("click", () => exportBlocks("csv"));

      // Initialize
      (function init() {
        loadPaginationState(); updateMiners(); updateStats(); updateBlocks(); updateBestShares(); updatePayouts(); updateEarnings(); updateConfig(); updateDaemonStatus(); updateDisconnectedMiners(); updateDifficultyChart(24); updateHashrateChart(24);
        setInterval(updateMiners, 5000); setInterval(updateStats, 10000); setInterval(updateBlocks, 30000); setInterval(updateBestShares, 30000); setInterval(updateEarnings, 60000); setInterval(updateDaemonStatus, 30000);
        setInterval(() => { updateDifficultyChart(currentDifficultyHours); updateHashrateChart(currentHashrateHours); }, 5 * 60 * 1000);
      })();

      setInterval(() => { document.getElementById("last-update").textContent = new Date().toLocaleTimeString(); }, 1000);
    </script>

    <div id="modalOverlay" class="modal-overlay"></div>
    <div id="confirmModal" class="confirm-modal">
      <div class="modal-content">
        <h2 id="modalTitle"></h2>
        <p id="modalMessage"></p>
        <div class="modal-buttons">
          <button id="modalCancelBtn" class="modal-btn modal-btn-cancel">Cancel</button>
          <button id="modalConfirmBtn" class="modal-btn modal-btn-confirm">Confirm</button>
        </div>
      </div>
    </div>
  </body>
</html>
